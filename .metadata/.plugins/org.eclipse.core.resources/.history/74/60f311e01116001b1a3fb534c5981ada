/*
 * generated by Xtext 2.23.0.M3
 */
package org.xtext.example.landingpagedsl.validation;
import java.util.*; 

import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.EStructuralFeature;
import org.eclipse.xtext.nodemodel.util.NodeModelUtils;
import org.eclipse.xtext.validation.Check;
import org.xtext.example.landingpagedsl.lPDSL.ImagePath;
import org.xtext.example.landingpagedsl.lPDSL.LPDSLPackage;
import org.xtext.example.landingpagedsl.lPDSL.LandingPage;
import org.xtext.example.landingpagedsl.lPDSL.PageBody;
import org.xtext.example.landingpagedsl.lPDSL.PageComponent;
import org.xtext.example.landingpagedsl.lPDSL.PageHeader;
import org.xtext.example.landingpagedsl.lPDSL.QualifiedPath;
import org.xtext.example.landingpagedsl.lPDSL.Sections;
import org.xtext.example.landingpagedsl.lPDSL.TabItems;
import com.google.common.base.Objects;
import java.util.regex.*;
/**
 * This class contains custom validation rules. 
 *
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#validation
 */
public class LPDSLValidator extends AbstractLPDSLValidator {
	
//TODO: path in image is correct format path, same for link in link
	
	//TODO: all tab names corresponds to a section name
	public static final String INVALID_NAME = "invalidName";
	
	@Check
	public void tabHasSection (LandingPage page) {
		List tabNames = new ArrayList();
		List secNames = new ArrayList();
		for(PageComponent p : page.getPagecomponent()) {
			for(EObject t : p.eContents()) {
				if (t.getClass().getSimpleName().toString().equals("TabItemsImpl")) {
					var eClass = t.eClass();
					var structuralFeature = eClass.getEStructuralFeature("name");
					var nodes = NodeModelUtils.findNodesForFeature(t, structuralFeature);
					for(var node : nodes) {
						tabNames.add(node.getText());
					}
				}
			}
		}

		for(PageComponent p : page.getPagecomponent()) {
			for(EObject t : p.eContents()) {
				if (t.getClass().getSimpleName().toString().equals("ResumeImpl") || t.getClass().getSimpleName().toString().equals("AboutMeImpl")) {
					var eClass = t.eClass();
					var structuralFeature = eClass.getEStructuralFeature("name");
					var nodes = NodeModelUtils.findNodesForFeature(t, structuralFeature);
					for(var node : nodes) {
						secNames.add(node.getText());
					}
				}
			}
		}
		//boolean flag = True;
		
		Set set = new HashSet(tabNames);
		if(set.size() < tabNames.size()) {
			error("Tabs must have unique names", LPDSLPackage.Literals.LANDING_PAGE__PAGECOMPONENT);
		}
		else {
			for(var s : tabNames) {
				if(!secNames.contains(s)) {
					error("you fucked up, Each Tab has to have a corresponding section!", LPDSLPackage.Literals.LANDING_PAGE__PAGECOMPONENT);
				}
			}
			
		}
	}
	
	@Check
	public void tabCapitalLetter(TabItems tab) {
		if (!Character.isUpperCase(tab.getName().charAt(0))) {
			warning("Name should start with a capital",
					LPDSLPackage.Literals.TAB_ITEMS__NAME,
					INVALID_NAME);
		}
	}
	
	@Check
	public void checkOnePageBody(LandingPage page) {
		int check = 0;
		for(PageComponent component : page.getPagecomponent()) {
			if (component.getClass().getSimpleName().toString().equals("PageBodyImpl")) {
				check += 1;
			}
		}
		if(check > 1) {
			error("There can only be one body section in your landing page", LPDSLPackage.Literals.LANDING_PAGE__PAGECOMPONENT);
		}
	}
	
	@Check
	public void checkOnePageHeader(LandingPage page) {
		int check = 0;
		for(PageComponent component : page.getPagecomponent()) {
			if (component.getClass().getSimpleName().toString().equals("PageHeaderImpl")) {
				check += 1;
			}
		}
		if(check > 1) {
			error("There can only be one header section in your landing page", LPDSLPackage.Literals.LANDING_PAGE__PAGECOMPONENT);
		}
	}
	
	@Check
	public void checkOnePageFooter(LandingPage page) {
		int check = 0;
		for(PageComponent component : page.getPagecomponent()) {
			if (component.getClass().getSimpleName().toString().equals("PageFooterImpl")) {
				check += 1;
			}
		}
		if(check > 1) {
			error("There can only be one footer section in your landing page", LPDSLPackage.Literals.LANDING_PAGE__PAGECOMPONENT);
		}
	}
	
	@Check 
	public void validURL(QualifiedPath path) {
		Pattern p = Pattern.compile("^(https?|ftp|file)://[-a-zA-Z0-9+&@#/%?=~_|!:,.;]*[-a-zA-Z0-9+&@#/%=~_|]");
		Matcher m = p.matcher(path.getValue());
		if (!m.matches()){
			warning("Your URL might not be valid", LPDSLPackage.Literals.QUALIFIED_PATH__VALUE);
		}
		
				
	}
	
	@Check 
	public void validImagePath(ImagePath path) {
		Pattern p = Pattern.compile("([^\\s]+(\\.(?i)(jpg|png|JPG|PNG))$)");
		Matcher m = p.matcher(path.getValue());
		if (!m.matches()){
			warning("Your URL might not be valid", LPDSLPackage.Literals.QUALIFIED_PATH__VALUE);
		}
		
				
	}
}
